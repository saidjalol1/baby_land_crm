{% extends 'wrapper.html' %}
{% load humanize %}
{% block title %}{{ storage.name }}{% endblock title %}
{% block content %}
<style>
  table{
    overflow: auto;
  }
  tr:hover {
    background-color: rgb(194, 190, 190);
  }
  .product_a{
    margin-right: 10px;
    background-color: white;
    color: black;
  }
  #scannerInput {
        position: absolute;
        top: -9999px;
    }
</style><!-- End Page Title -->
<h1>Ombor</h1>
  <div class="d-flex justify-content-end align-items-center">
    <div>
      <form method="POST">
        {% csrf_token %}
        <a type="button" class="btn product_a" href="{% url 'main_app:products' %}">Mahsulotlar</a>
        <a type="button" class="btn product_a" href="{% url 'main_app:storage_history' %}">Tarix</a>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exampleModal">Qo'shish</button>
      </form>
    </div>
  </div>
  {% if messages %}
<ul class="messages text-center mt-10" style="color: red;">
    {% for message in messages %}
    <h1{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</h1>
    {% endfor %}
</ul>
{% endif %}

    <div class="row mt-4" style="overflow-x: auto;"> 
      {% if page_obj_products %}
            <table class="table" >
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">ID</th>
                  <th scope="col">Nomi</th>
                  <th scope="col">Miqdori</th>
                  <th scope="col">Tan narxi</th>
                  <th scope="col">Sotuv narxi</th>
                  <th scope="col">Jami summa</th>
                </tr>
              </thead>
              <tbody>
                {% for i in page_obj_products %}
                <tr>
                  <th scope="row">{{ i.id }}</th>
                  <td>{{ i.product_id }}</td>
                  <td>{{ i.name }}</td>
                  <td>{{ i.amount }}</td>
                  <td>{{ i.base_price|intcomma }} UZS</td>
                  <td>{{ i.sale_price|intcomma }} UZS</td>
                  <td>{{ i.overall|intcomma }} UZS</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
              <div style="color: gray;font-size:20px;text-align:center">
                Ma'lumot mavjud emas!!!
              </div>
            {% endif %}
            <nav aria-label="Page navigation">
              <ul class="pagination justify-content-center">
                {% if page_obj_products.has_previous %}
                  <li class="page-item"><a class="page-link" href="?page_products={{ page_obj_products.previous_page_number }}">Oldingi</a></li>
                {% endif %}
                {% for num in page_obj_products.paginator.page_range %}
                  {% if page_obj_products.number == num %}
                    <li class="page-item active"><a class="page-link" href="?page_products={{ num }}">{{ num }}</a></li>
                  {% else %}
                    <li class="page-item"><a class="page-link" href="?page_products={{ num }}">{{ num }}</a></li>
                  {% endif %}
                {% endfor %}
                {% if page_obj_products.has_next %}
                  <li class="page-item"><a class="page-link" href="?page_products={{ page_obj_products.next_page_number }}">Keyingi</a></li>
                {% endif %}
              </ul>
            </nav>
    </div>
    <!-- Button trigger modal -->
    <div class="row mt-4" style="overflow-x: auto;"> 
      <div class="card">
        <div class="card-header d-flex justify-content-between w-full">
          <div class="d-flex justify-content-between align-items-center gap-5"><h3>Balans</h3><h5 style="color: red;">{{ balance|intcomma}} uzs</h5></div>
          <div>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#payment_modal">To'lov qo'shish</button>
          </div>
        </div>
        
      </div>
      <div class="card-body">
        {% if payments %}
            <table class="table" >
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Sanasi</th>
                  <th scope="col">Miqdori</th>
                </tr>
              </thead>
              <tbody>
                {% for i in payments %}
                <tr>
                  <th scope="row">{{ i.id }}</th>
                  <td>{{ i.date.month }}/{{ i.date.day }}/{{ i.date.year }}</td>
                  <td>{{ i.amount|intcomma }}UZS</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
              <div style="color: gray;font-size:20px;text-align:center">
                Ma'lumot mavjud emas!!!
              </div>
            {% endif %}
            <nav aria-label="Page navigation">
              <ul class="pagination justify-content-center">
                {% if payments.has_previous %}
                  <li class="page-item"><a class="page-link" href="?page_payments={{ payments.previous_page_number }}">Oldingi</a></li>
                {% endif %}
                {% for num in payments.paginator.page_range %}
                  {% if payments.number == num %}
                    <li class="page-item active"><a class="page-link" href="?page_payments={{ num }}">{{ num }}</a></li>
                  {% else %}
                    <li class="page-item"><a class="page-link" href="?page_payments={{ num }}">{{ num }}</a></li>
                  {% endif %}
                {% endfor %}
                {% if payments.has_next %}
                  <li class="page-item"><a class="page-link" href="?page_payments={{ payments.next_page_number }}">Keyingi</a></li>
                {% endif %}
              </ul>
            </nav>
      </div>
    </div>
    <input type="text" id="scannerInput" autofocus>
   <!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Qo'shish</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST">
          {% csrf_token %}
          <div class="mb-3">
            <label for="formGroupExampleInput" class="form-label">Qr Code ID:</label>
            <input type="text" class="form-control"  name="product_id" required>
          </div>
          <div class="mb-3">
            <label for="formGroupExampleInput2" class="form-label">Miqdori:</label>
            <input type="number" class="form-control" id="formGroupExampleInput2" name="amount" required>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
            <button type="submit" class="btn btn-primary" name="add">Saqlash</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="payment_modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">To'lov Qo'shish</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST">
          {% csrf_token %}
          <div class="mb-3">
            <label for="formGroupExampleInput" class="form-label">Sanasi:</label>
            <input type="date" class="form-control" id="formGroupExampleInput"  name="date" required>
          </div>
          <div class="mb-3">
            <label for="formGroupExampleInput2" class="form-label">Miqdori:</label>
            <input type="number" class="form-control" id="formGroupExampleInput2" name="amount" required>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
            <button type="submit" class="btn btn-primary" name="add_payment">Saqlash</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="editProduct" tabindex="-1" aria-labelledby="editProductModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Tahrirlash</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST">
          {% csrf_token %}
          <input type="hidden" value="product_id" name="product" id="product_id">
          <div class="mb-3">
            <label for="formGroupExampleInput" class="form-label">Nomi:</label>
            <input type="text" class="form-control" placeholder="Nomi" name="name" required  id="name">
          </div>
          <div class="mb-3">
            <label for="formGroupExampleInput2" class="form-label">Miqdori:</label>
            <input type="number" class="form-control"  placeholder="Miqdori" name="amount" required  id="amount">
          </div>
          <div class="mb-3">
            <label for="formGroupExampleInput2" class="form-label">O'lchov birligi</label>
            <select name="measurement_unit" required=True class="form-select" id="measurement_unit">
                <option value="litr">Litr</option>
                <option value="tonna">To'nna</option>
                <option value="dona">Dona</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="formGroupExampleInput2" class="form-label">Sof foyda</label>
            <input type="number" class="form-control"  placeholder="Sof foyda" name="income"  required id="income">
          </div>
          <div class="mb-3">
            <label for="formGroupExampleInput2" class="form-label">Tan narxi</label>
            <input type="number" class="form-control"  placeholder="Tan narxi" name="body_price"  required id="body_price">
          </div>
          <div class="mb-3">
            <label for="formGroupExampleInput2" class="form-label">Limit</label>
            <input type="number" class="form-control"  placeholder="Limit" name="limit" required id="limit" >
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
            <button type="submit" class="btn btn-primary" name="save">Saqlash</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', (event) => {
      const scannerInput = document.getElementById('scannerInput');
      const qrCodeIdInput = document.getElementById('qrCodeId');

      // Listen for input from the hidden input field
      scannerInput.addEventListener('input', (event) => {
          const data = event.target.value;
          if (data) {
              // Fill the QR Code ID input field
              qrCodeIdInput.value = data;

              // Open the modal
              $('#productModal').modal('show');

              // Clear the input field
              scannerInput.value = '';
          }
      });

      // Focus on the hidden input field to capture scanner input
      scannerInput.focus();
  });
</script>
{% endblock content %}